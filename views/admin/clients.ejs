<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="fas fa-address-book me-2"></i>Gestion des Clients</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newClientModal">
            <i class="fas fa-plus me-1"></i> Nouveau Client
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 80px;">ID</th>
                            <th>Nom</th>
                            <th style="width: 200px;">Email</th>
                            <th style="width: 150px;">Téléphone</th>
                            <th>Adresse</th>
                            <th style="width: 120px;">Date création</th>
                            <th style="width: 100px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% clients.forEach(client => { %>
                            <tr>
                                <td><span class="badge bg-secondary">#<%= client.id %></span></td>
                                <td><strong><%= client.nom %></strong></td>
                                <td><%= client.email || '<span class="text-muted">N/A</span>' %></td>
                                <td><%= client.telephone || '<span class="text-muted">N/A</span>' %></td>
                                <td class="text-truncate" style="max-width: 200px;" title="<%= client.adresse || 'N/A' %>">
                                    <%= client.adresse ? client.adresse.substring(0, 40) + '...' : '<span class="text-muted">N/A</span>' %>
                                </td>
                                <td><%= new Date(client.createdAt).toLocaleDateString('fr-FR') %></td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-info" title="Voir détails">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-warning" title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal New Client -->
<div class="modal fade" id="newClientModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Nouveau Client</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/admin/clients">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <h6 class="text-muted mb-3"><i class="fas fa-info-circle me-1"></i>Informations générales</h6>
                            <div class="mb-3">
                                <label for="nom" class="form-label">Nom complet *</label>
                                <input type="text" class="form-control" id="nom" name="nom" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="email" name="email">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="telephone" class="form-label">Téléphone</label>
                                        <input type="tel" class="form-control" id="telephone" name="telephone">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="adresse" class="form-label">Adresse</label>
                                <textarea class="form-control" id="adresse" name="adresse" rows="3" placeholder="Adresse complète du client"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="latitude" class="form-label">Latitude</label>
                                        <input type="number" class="form-control" id="latitude" name="latitude" step="any" readonly>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="longitude" class="form-label">Longitude</label>
                                        <input type="number" class="form-control" id="longitude" name="longitude" step="any" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <h6 class="text-muted mb-3"><i class="fas fa-map-marker-alt me-1"></i>Localisation</h6>
                            <div class="mb-3">
                                <div class="card">
                                    <div class="card-body p-0">
                                        <div id="map" style="height: 450px; border-radius: 0.375rem;"></div>
                                    </div>
                                </div>
                                <small class="text-muted">Cliquez sur la carte pour sélectionner l'emplacement</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Créer le client
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let map = null;
let marker = null;

function initMap() {
    if (map) {
        map.remove();
    }
    
    map = L.map('map').setView([-18.8792, 47.5079], 8);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);

    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        document.getElementById('latitude').value = lat.toFixed(6);
        document.getElementById('longitude').value = lng.toFixed(6);

        if (marker) {
            map.removeLayer(marker);
        }

        marker = L.marker([lat, lng]).addTo(map)
            .bindPopup('<strong>Emplacement sélectionné</strong><br>Lat: ' + lat.toFixed(6) + '<br>Lng: ' + lng.toFixed(6))
            .openPopup();
    });

    setTimeout(() => {
        map.invalidateSize();
    }, 100);
}

document.getElementById('newClientModal').addEventListener('shown.bs.modal', function () {
    initMap();
});

document.getElementById('newClientModal').addEventListener('hidden.bs.modal', function () {
    if (map) {
        map.remove();
        map = null;
        marker = null;
    }
    // Reset form
    document.querySelector('#newClientModal form').reset();
});
</script>
